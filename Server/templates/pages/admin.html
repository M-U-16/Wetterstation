{% extends "base/base.html" %}
{% from "svgs/close.html" import close %}
{% from "components/flashed-messages.html" import FlashedMessages %}

{% block title %}| Admin{% endblock title %}
{% block styles %}
    <style>
        .admin-container {
            width: 100%;
            height: 100%;
            padding: 1rem;
            margin: auto;
            max-width: 55rem;
        }

        .information-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .information-container .info {
            padding: 1rem;
            background-color: white;
            border: 1px solid rgb(189, 189, 189);
            display: flex;
            align-items: center;
            border-radius: 5px;
            gap: 0.5rem;
        }
        
        .password-form input {
            padding: 0.8rem;
            border: 1px solid rgb(189, 189, 189);
            background-color: white;
            border-radius: 5px 0 0 5px;
            font-size: 1rem;
        }

        .password-form button {
            background-color: var(--highlight-clr);
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            padding: 0 1rem;
            cursor: pointer;
        }

        .select-container {
            padding: 0.5rem 0;
        }

        h3.normal-heading {
            font-weight: 500;
            font-size: 1.3rem;
        }

        .wettereinheit-controls button {
            padding: 0.5rem;
            border-radius: 5px;
            border: none;
            color: white;
            cursor: pointer;
        }

        .wettereinheit-controls button.start {
            background-color: rgb(212, 255, 212);
            border: 1px solid green;
            color: rgb(0, 126, 0);
        }
        
        .wettereinheit-controls button.stop {
            background-color: rgb(255, 223, 223);
            border: 1px solid red;
            color: rgb(219, 0, 0);
        }
        
        .wettereinheit-controls button.restart {
            background-color: #fff7e4;
            border: 1px solid #ffae00;
            color: #ce8d00;
        }

        .select-container select,
        .select-container input {
            padding: 0.8rem;
            border: 1px solid rgb(168, 168, 168);
        }
        
        .select-container input {
            width: 6rem;
            border-radius: 5px 0 0 5px;
        }
        
        .select-container select {
            border-radius: 0 5px 5px 0;
            border-left: none;
        }

        .input-container {
            display: flex;
        }

        #save-button {
            padding: 0.8rem 1.5rem;
            background-color: var(--highlight-clr);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>

{% endblock styles %}
{% block titlebarHeading %}Admin{% endblock titlebarHeading %}

{% macro NumberSelect(name, value, extra) %}
    {% if extra %}
        {% set value, selected = extra.split(",") %}
    {% else %}
        {% set selected = "sec" %}
    {% endif %}

    <input
        name="{{ name }}"
        type="number" min="1"
        value="{{ value }}"
        data-first="{{ value }}"
        onchange="onchange_event(event)"
    >
    <select
        name="{{ name }}-type"
        data-first="{{ selected }}"
        onchange="onchange_event(event)"
    >
        <option value="sec" {{ "selected" if selected == "sec" }}>Sekunde(n)</option>
        <option value="min" {{ "selected" if selected == "min" }}>Minute(n)</option>
        <option value="h" {{ "selected" if selected == "h" }}>Stunde(n)</option>
        <option value="d" {{ "selected" if selected == "d" }}>Tag(e)</option>
    </select>
{% endmacro %}

{% block content %}
    <div class="admin-container">
        <div class="information-container">
            <div class="info">
                <h3>Letzte Messung:</h3>
                <p>
                    {% if last_entry %}
                        {{ last_entry | date_format }}
                    {% else %}
                        Nicht verfügbar
                    {% endif %}
                </p>
            </div>
            <div class="info">
                <h3>CPU-Temperatur:</h3>
                <p>
                    {% if data %}
                        {{ data["cpuTemp"] }}
                    {% else %}
                        Nicht verfügbar
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="settings" style="margin-bottom: 0.5rem;">
            <h1 style="margin-bottom: 0.5rem;">Generelle Einstellungen</h1>
            <h3 class="normal-heading">Admin-Passwort</h3>
            <form
                action="/admin/change-password"
                onsubmit="changePassword(event)"
                method="post"
                style="display: flex;"
                class="password-form"
            >
                <div style="width: min-content;">
                    <input class="password-input" type="text" placeholder="Passwort" name="password" value="{{password}}">
                </div>
                <button type="submit">Passwort ändern</button>
            </form>
        </div>

        <h1 style="margin-bottom: 0.5rem;">Wettereinheit</h1>
        <div class="wettereinheit-controls">
            <button class="start">Starten</button>
            <button class="stop">Stoppen</button>
            <button class="restart">Neustarten</button>
        </div>

        <form
            class="pi-settings"
            method="POST"
            action="/api/settings/wettereinheit"

            x-data="{saveButton: false}"
        >
            <div class="select-container">
                <h3 class="normal-heading">Messinterval</h3>
                {% if settings["Interval"] %}
                    <div class="input-container">
                        {{ NumberSelect(
                            "interval",
                            settings["Interval"]["value"],
                            settings["Interval"]["extra"]
                        )}}
                    </div>
                {% else %}
                    <p>Einstellungen konnten nicht geladen werden.</p>
                {% endif %}
            </div>
            <div class="select-container">
                <h3 class="normal-heading">Messverzögerung (Gassensor)</h3>
                {% if settings["GasStartUpTime"] %}
                    <div class="input-container">
                        {{ NumberSelect(
                            "gas-startup",
                            settings["GasStartUpTime"]["value"],
                            settings["GasStartUpTime"]["extra"]
                        )}}
                    </div>
                {% else %}
                    <p>Einstellungen konnten nicht geladen werden.</p>
                {% endif %}
            </div>
            <button
                id="save-button"
                type="submit"
            >Speichern</button>
        </form>
    </div>
{% endblock content %}

{% block scripts %}
<script>
    function changePassword(event) {
        event.preventDefault()
        const input = event.srcElement.querySelector("input[name=password]")

        fetch("/admin/change-password", {
            body: JSON.stringify({
                password: input.value
            }),
            headers: {
                "Content-Type": "application/json"
            },
            method: "POST",
        }).then(res => res.json()).then(res => {
            console.log(res)
            if (!res.error) {
                NewFlashedMessage("Passwort geändert!", "success")
            }
            
        }).catch(error => {
            console.error(error)
            NewFlashedMessage("Passwort konnte nicht ", "error")
        })
    }

    const form = document.querySelector(".pi-settings")
    const flashedMessage = document.querySelector(".flashed-messages")

    const interval = document.querySelector(".pi-settings input[name='interval']")
    const intervalType = document.querySelector(".pi-settings select[name='interval-type']")

    const gasStartUp = document.querySelector(".pi-settings input[name='gas-startup']")
    const gasStartUpType = document.querySelector(".pi-settings select[name='gas-startup-type']")
    //console.log(gasStartUp, gasStartUpType)

    function onchange_event(e) {
        console.log(e.srcElement.value)
    }

    // returns the given time in seconds
    function time_to_second(time) {
        if (time == "sec") {
            return 1
        } else if (time == "min") {
            return 60
        } else if (time == "h") {
            return 3600
        } else if (time == "d") {
            return 24*3600
        }
    }

    document.querySelector(".pi-settings button[type='submit']").addEventListener("click", (e) => {
        e.preventDefault()
        
        fetch("/api/settings/wettereinheit", {
            body: JSON.stringify({
                Interval: {
                    value: interval.value * time_to_second(intervalType.value),
                    extra: interval.value.toString()+","+intervalType.value
                },
                GasStartUpTime: {
                    value: gasStartUp.value * time_to_second(gasStartUpType.value),
                    extra: gasStartUp.value.toString()+","+gasStartUpType.value
                }
            }),
            headers: {
                "Content-Type": "application/json"
            },
            method: "POST",
        }).then(async(res) => {
            
            const json = await res.json()
            if (json.error) {
                NewFlashedMessage("Fehler beim speichern", "error")
            }
        }).catch(err => {
            console.log(err)
        })
    })
</script>
{% endblock scripts %}